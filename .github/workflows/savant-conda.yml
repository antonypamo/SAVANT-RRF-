name: SAVANT-RRF Conda Build & Test

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4

    steps:
    # 1Ô∏è‚É£ Checkout del repositorio
    - uses: actions/checkout@v4

    # 2Ô∏è‚É£ Configurar Miniconda con soporte Mamba
    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        python-version: 3.10
        auto-update-conda: true
        use-mamba: true
        activate-environment: savant-env

    # 3Ô∏è‚É£ Cache de dependencias para acelerar builds
    - name: Cache Conda packages
      uses: actions/cache@v3
      with:
        path: ~/.conda/pkgs
        key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
        restore-keys: |
          ${{ runner.os }}-conda-

    # 4Ô∏è‚É£ Crear o actualizar entorno Conda
    - name: Create or Update Conda Environment
      run: |
        if [ -f environment.yml ]; then
          echo "üß© Using environment.yml..."
          mamba env update -n savant-env -f environment.yml
        else
          echo "‚öôÔ∏è No environment.yml found, creating manually..."
          mamba create -n savant-env python=3.10 numpy scipy torch gitpython faiss-cpu=1.11.0 pytest flake8 -y
        fi

    # 5Ô∏è‚É£ Activar entorno
    - name: Activate Conda environment
      shell: bash -l {0}
      run: |
        conda activate savant-env
        conda list

    # 6Ô∏è‚É£ Lint con flake8
    - name: Lint with flake8
      shell: bash -l {0}
      run: |
        conda activate savant-env
        echo "üßπ Running flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=12 --max-line-length=127 --statistics

    # 7Ô∏è‚É£ Test con pytest
    - name: Test with pytest
      shell: bash -l {0}
      run: |
        conda activate savant-env
        echo "üß™ Running tests..."
        pytest -v --maxfail=3 --disable-warnings

    # 8Ô∏è‚É£ (Opcional) Subir resultados de test
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: ./tests/reports/
